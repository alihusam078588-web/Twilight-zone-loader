name: Twisted of the Day (Tumblr FINAL)

on:
  schedule:
    - cron: '0 22 * * *' # 22:00 UTC â‰ˆ 1:00 AM Iraq time
  workflow_dispatch:

jobs:
  send:
    runs-on: ubuntu-latest

    steps:
      - name: Get Today's Twisted and send webhook
        run: |
          python3 << 'EOF'
          import requests
          import xml.etree.ElementTree as ET
          import re
          import html
          from datetime import datetime

          RSS_URL = "https://twisted-of-the-day.tumblr.com/rss"
          WEBHOOK_URL = "https://discord.com/api/webhooks/1449788203082191100/E6NMZ-b7wc-PHLS4lRY0E6ZV4Yas5IXLLHOIP8iN-8fn5L1KNkcBUhWsQytL2T9BVLpK"

          rss_text = requests.get(RSS_URL, timeout=20).text
          root = ET.fromstring(rss_text)

          twisted = "Unknown Twisted"

          for item in root.findall(".//item"):
              desc_el = item.find("description")
              if desc_el is None or not desc_el.text:
                  continue

              # Decode HTML entities
              text = html.unescape(desc_el.text)

              # Remove ALL html tags
              text = re.sub(r"<[^>]+>", "", text)

              # Normalize dots
              text = text.replace("â€¦", "...")

              # Look for: Today's twisted is...
              match = re.search(
                  r"Today.?s twisted is\.{3}\s*([A-Za-z\s]+)!?",
                  text,
                  re.IGNORECASE
              )

              if match:
                  twisted = match.group(1).strip()
                  break

          payload = {
              "username": "Dandy's World",
              "embeds": [
                  {
                      "title": "ðŸŒ€ Twisted of the Day",
                      "description": f"**{twisted}**",
                      "color": 10181046,
                      "footer": {
                          "text": "Twisted of the Day"
                      },
                      "timestamp": datetime.utcnow().isoformat()
                  }
              ]
          }

          requests.post(WEBHOOK_URL, json=payload)
          EOF
